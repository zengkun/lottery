<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Expires" content="-1">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Pragma" content="no-cache">
    <link rel="stylesheet" type="text/css" href="css/public.css">
    <link rel="stylesheet" type="text/css" href="css/lottery.css" />
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <title>幸运大转盘</title>
</head>

<body>
    <div class="all">
        <div class="lottery_banner">
            <img src="images/banner.png" alt="" />
        </div>
        <div class="lottery_times">还有<span class="num">1</span>次抽奖机会</div>
        <div class="lottery">
            <div class="shanDeng" id="deng">
                <div id="luck">
                    <table style="border-spacing:.1rem .1rem;">
                        <tr>
                            <td class="luck-unit luck-unit-0">
                                <img src="https://weixiao.qq.com/public/applottery/img/xiexie.png" alt="" />
                                <div>谢谢惠顾</div>
                            </td>
                            <td class="luck-unit luck-unit-1">
                                <img src="https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516945PXHMSG.png" alt="" />
                                <div>钢化膜</div>
                            </td>
                            <td class="luck-unit luck-unit-2">
                                <img src="https://weixiao.qq.com/public/applottery/img/xiexie.png" alt="" />
                                <div>谢谢惠顾</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="luck-unit luck-unit-7">
                                <img src="https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1887573477,2372872127&fm=26&gp=0.jpg" alt="" />
                                <div>数据线</div>
                            </td>
                            <td class="cjBtn" id="btn"></td>
                            <td class="luck-unit luck-unit-3">
                                <img src="https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516942VDMZEP.png" alt="" />
                                <div>移动电源</div>
                            </td>
                        </tr>
                        <tr>
                            <td class="luck-unit luck-unit-6">
                                <img src="https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516914SYSKYH.png" alt="" />
                                <div>智能手机</div>
                            </td>
                            <td class="luck-unit luck-unit-5">
                                <img src="https://weixiao.qq.com/public/applottery/img/xiexie.png" alt="" />
                                <div>谢谢惠顾</div>
                            </td>
                            <td class="luck-unit luck-unit-4">
                                <img src="https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516921QHMYPW.png" alt="" />
                                <div>平板电脑</div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <!--我的奖品-->
        <div class="my_gift" id="my_gift" style="display: none;">
            <div class="title_block">
                <div class="title">我的奖品</div>
            </div>
            <table class="gift_img" border="0" cellspacing="0" cellpadding="0">
                <tbody>
                    <tr>
                        <td style="width: 1rem;">
                            <img class="gift-img-id" src="" alt="" />
                        </td>
                        <td>
                            <div class="gift_name gift-name-id">
                            </div>
                            <div class="gift_time">
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!--我的奖品-->
        <!--我的奖品-->
        <div class="my_gift">
            <div class="title_block">
                <div class="title">活动规则</div>
            </div>
            <table class="gift_content" border="0" cellspacing="0" cellpadding="0">
                <tbody>
                    <tr>
                        <td style="width: 1rem;">
                            <p class="gtitle">活动时间</p>
                            <p>2020-11-30 00:00:00 ~ 2021-01-31 00:00:00</p>
                            <br>
                            <p class="gtitle">活动说明</p>
                            <p class="gsubtitle">活动参与条件：</p>
                            <p>1.投票即可免费参与。 </p>
                            <p>2.奖品必须在门店实名登记领取。 </p>
                            <p>3.以上抽取的电子产品均为存费送机。 </p>
                            <p>4.活动手机为vivo、oppo、华为等机型，详情请咨询工作人员。 </p>
                            <p>5.本活动最终解析权归本门店所有。 </p>
                            <p>6.年满18周岁方可参与本次活动。 </p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <!--我的奖品-->
    </div>
    <div class="cover dis_no"></div>
    <!--结果弹窗开始-->
    <div class="result_box dis_no">
        <div class="card_box">
            <div class="card_top">
                <div class="title">
                    <img src="images/icon-note.png" alt="" />
                    <span>获奖结果</span>
                </div>
            </div>
            <img class="gift-img-id" src="" alt="" />
            <div class="card_tips gift-name-id"></div>
            <input type="button" value="确认" class="btn_default">
        </div>
    </div>
    <!--结果弹窗结束-->
    <!--无机会弹窗开始-->
    <div class="count_box dis_no">
        <div class="card_box">
            <div class="card_top">
                <div class="title">
                    <img src="images/icon-note.png" alt="" />
                    <span>提示</span>
                </div>
            </div>
            <div class="card_tips">你已经没有抽奖机会了~</div>
            <input type="button" value="确认" class="btn_default">
        </div>
    </div>
    <!--无机会弹窗结束-->
    <div class="loading-error-page" style="display: none;">
        <h3 class="error-title">请在微信浏览器中打开</h3>
    </div>
</body>
<script>
var giftList = {
    0: {
        name: '谢谢惠顾',
        tip: '',
        img: 'https://weixiao.qq.com/public/applottery/img/xiexie.png',
    },
    1: {
        name: '钢化膜',
        tip: '恭喜你抽中',
        img: 'https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516945PXHMSG.png',
    },
    2: {
        name: '谢谢惠顾',
        tip: '恭喜你抽中',
        img: 'https://weixiao.qq.com/public/applottery/img/xiexie.png',
    },
    3: {
        name: '移动电源',
        tip: '',
        img: 'https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516942VDMZEP.png',
    },
    4: {
        name: '平板电脑',
        tip: '恭喜你抽中',
        img: 'https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516921QHMYPW.png',
    },
    5: {
        name: '谢谢惠顾',
        tip: '',
        img: 'https://weixiao.qq.com/public/applottery/img/xiexie.png',
    },
    6: {
        name: '智能手机',
        tip: '恭喜你抽中',
        img: 'https://wxpublic-1251448646.file.myqcloud.com/mobile/20191123/1574516914SYSKYH.png',
    },
    7: {
        name: '数据线',
        tip: '恭喜你抽中',
        img: 'https://ss2.bdstatic.com/70cFvnSh_Q1YnxGkpoWK1HF6hhy/it/u=1887573477,2372872127&fm=26&gp=0.jpg',
    },
}
// 1:钢化膜 2:谢谢惠顾 4:平板电脑 6:智能手机 7:数据线
var luckList = {
    '2ad8f5fa5123d943cd21e0977fd92535': 1,
    '8ec32aa42bb126a294775680a90a7090': 2,
    '73691dde7b6e79cf9bcd000a21f71bfe': 4,
    '6f07d6a0d090a6907be97a70971b0c56': 6,
    '3743378a5730cf6ac1c1123a90e55b8f': 7,
}
var luck = {
    count: 1, // 几次抽奖机会
    index: -1, // 当前转动到哪个位置，起点位置
    position: 0, // 总共有多少个位置
    timer: 0, // setTimeout的ID，用clearTimeout清除
    speed: 20, // 初始转动速度
    times: 0, // 转动次数
    cycle: 50, // 转动基本次数：即至少需要转动多少次再进入抽奖环节
    prize: -1, // 中奖位置
    init: function(id) {
        if ($("#" + id).find(".luck-unit").length > 0) {
            $luck = $("#" + id);
            $units = $luck.find(".luck-unit");
            this.obj = $luck;
            this.position = $units.length;
            $luck.find(".luck-unit-" + this.index).addClass("active");
            $(".num").html(this.count)
        };
    },

    roll: function() {
        var index = this.index;
        var position = this.position;
        var luck = this.obj;
        $(luck).find(".luck-unit-" + index).removeClass("active");
        index += 1;
        if (index > position - 1) {
            index = 0;
        };
        $(luck).find(".luck-unit-" + index).addClass("active");
        this.index = index;
        return false;
    },
    stop: function(index) {
        this.prize = index;
        return false;
    }
};

function roll() {
    luck.times += 1;
    luck.roll();
    if (luck.times > luck.cycle + luck.position - luck.prize && luck.prize == luck.index) {
        clearTimeout(luck.timer);
        // luck.prize = -1;
        // luck.times = 0;
    } else {
        if (luck.times < luck.cycle) {
            luck.speed -= 10;
        } else if (luck.times == luck.cycle) {
            // 最终中奖位置
            var _prize = getQueryVariable("aid")
            luck.prize = luckList[_prize] || 2;

            $(".gift-img-id").prop("src", giftList[luck.prize].img)
            $(".gift-name-id").html(giftList[luck.prize].tip + giftList[luck.prize].name)
            $(".gift_time").html(new Date().format("yyyy-MM-dd hh:mm:ss"))
        } else {
            if (luck.times > luck.cycle + luck.position - luck.prize && luck.prize == luck.index + 1) {
                luck.speed += 110;
            } else {
                luck.speed += 20;
            }
        }
        if (luck.speed < 40) {
            luck.speed = 40;
        };

        luck.timer = setTimeout(roll, luck.speed);
    }
    return false;
}

var click = true;
window.onload = function() {
    if (!isWeiXin() && window.location.host.indexOf("bmobile-shop.com") !== -1) {
        $(".loading-error-page").show()
        $(".all").hide()
        return;
    }

    luck.init('luck');
    var giftPrize = localStorage.getItem("giftPrize")
    console.log('giftPrize: ', giftPrize);
    if (giftPrize) {
        luck.count = 0
        $(".num").html(luck.count)
        $(".gift-img-id").prop("src", giftList[giftPrize].img)
        $(".gift-name-id").html(giftList[giftPrize].tip + giftList[giftPrize].name)
        $(".gift_time").html(localStorage.getItem("giftTime"))
        $("#my_gift").show()
    }

    $("#btn").click(function() {
        $luck.find(".luck-unit").removeClass("active");
        luck.index = -1;
        luck.speed = 100;

        if (luck.count <= 0) {
            $(".cover").removeClass("dis_no");
            $(".count_box").removeClass("dis_no");
            $("body,html").css({
                "height": "100%",
                "overflow": "hidden"
            })
            return
        }

        if (!click) return

        roll();

        click = false;
        setTimeout(function() {
            $(".cover").removeClass("dis_no");
            $(".result_box").removeClass("dis_no");
            $("body,html").css({
                "height": "100%",
                "overflow": "hidden"
            })
            click = true;

            if (luck.count > 0) luck.count--
            $(".num").html(luck.count)

            $("#my_gift").show()

            localStorage.setItem("giftPrize", luck.prize);
            localStorage.setItem("giftTime", $(".gift_time").html());
        }, 4000);
    });
};

// ios弹窗位置调整
$("input").bind('focus', function() {
    var top = document.body.scrollTop;
    $(window).scrollTop(top);
})
$("input").bind('blur', function() {
    var top = document.body.scrollTop;
    $(window).scrollTop(top);
})
// 关闭弹窗
$(".btn_default").on("click", function() {
    $(".cover").addClass("dis_no");
    $(".result_box,.count_box").addClass("dis_no");
    $("body,html").css({
        "height": "100%",
        "overflow": "auto"
    })
})

function getQueryVariable(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split("&");
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split("=");
        if (pair[0] == variable) { return pair[1]; }
    }
    return (false);
}

function isWeiXin() {
    var ua = window.navigator.userAgent.toLowerCase();
    if (ua.match(/MicroMessenger/i) == "micromessenger") {
        return true;
    } else {
        return false;
    }
}

Date.prototype.format = function(fmt) {
    var o = {
        "M+": this.getMonth() + 1, //月份
        "d+": this.getDate(), //日
        "h+": this.getHours(), //小时
        "m+": this.getMinutes(), //分
        "s+": this.getSeconds(), //秒
        "q+": Math.floor((this.getMonth() + 3) / 3), //季度
        "S": this.getMilliseconds() //毫秒
    };
    if (/(y+)/.test(fmt)) {
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    }
    for (var k in o) {
        if (new RegExp("(" + k + ")").test(fmt)) {
            fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        }
    }
    return fmt;
}
</script>

</html>